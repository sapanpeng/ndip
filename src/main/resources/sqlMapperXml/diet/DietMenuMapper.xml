<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tenghong.ndip.mapper.diet.DietMenuMapper">
  <resultMap id="BaseResultMap" type="com.tenghong.ndip.model.diet.DietMenu">
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="oven_id" jdbcType="INTEGER" property="ovenId" />
    <result column="meal_id" jdbcType="INTEGER" property="mealId" />
    <result column="cafeteria_id" jdbcType="INTEGER" property="cafeteriaId" />
    <result column="sort" jdbcType="INTEGER" property="sort" />
    <result column="memo" jdbcType="VARCHAR" property="memo" />
    <result column="menu_time" jdbcType="TIMESTAMP" property="menuTime" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="create_by" jdbcType="INTEGER" property="createBy" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="update_by" jdbcType="INTEGER" property="updateBy" />
    <result column="status" jdbcType="INTEGER" property="status" />
  </resultMap>

  <resultMap id="MenuVoMap" type="com.tenghong.ndip.model.vo.MenuVo">
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="oven_id" jdbcType="INTEGER" property="ovenId" />
    <result column="meal_id" jdbcType="INTEGER" property="mealId" />
    <result column="menu_time" jdbcType="TIMESTAMP" property="menuTime" />
    <result column="price" jdbcType="DOUBLE" property="price" />
    <result column="type" jdbcType="INTEGER" property="type" />
    <result column="goalId" jdbcType="INTEGER" property="goalId" />
    <result column="relationId" jdbcType="INTEGER" property="relationId" />
    <result column="icon" jdbcType="VARCHAR" property="icon" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <association property="element" javaType="com.tenghong.ndip.model.diet.DietElement">
      <id column="element_id" jdbcType="INTEGER" property="elementId" />
      <result column="goal_type" jdbcType="INTEGER" property="goalType" />
      <result column="goal_id" jdbcType="INTEGER" property="goalId" />
      <result column="DEPARTMENT" jdbcType="VARCHAR" property="department" />
      <result column="ENERGY" jdbcType="VARCHAR" property="energy" />
      <result column="PROTEIN" jdbcType="VARCHAR" property="protein" />
      <result column="FAT" jdbcType="VARCHAR" property="fat" />
      <result column="CARBOHYDRATE" jdbcType="VARCHAR" property="carbohydrate" />
      <result column="DF" jdbcType="VARCHAR" property="df" />
      <result column="Ca" jdbcType="VARCHAR" property="ca" />
      <result column="Fe" jdbcType="VARCHAR" property="fe" />
      <result column="Zn" jdbcType="VARCHAR" property="zn" />
      <result column="Se" jdbcType="VARCHAR" property="se" />
      <result column="Cu" jdbcType="VARCHAR" property="cu" />
      <result column="Mn" jdbcType="VARCHAR" property="mn" />
      <result column="Mg" jdbcType="VARCHAR" property="mg" />
      <result column="Na" jdbcType="VARCHAR" property="na" />
      <result column="K" jdbcType="VARCHAR" property="k" />
      <result column="P" jdbcType="VARCHAR" property="p" />
      <result column="VITA" jdbcType="VARCHAR" property="vita" />
      <result column="VITE" jdbcType="VARCHAR" property="vite" />
      <result column="VITB1" jdbcType="VARCHAR" property="vitb1" />
      <result column="VITB2" jdbcType="VARCHAR" property="vitb2" />
      <result column="VITC" jdbcType="VARCHAR" property="vitc" />
      <result column="VITPP" jdbcType="VARCHAR" property="vitpp" />
      <result column="ASP" jdbcType="VARCHAR" property="asp" />
      <result column="WATER" jdbcType="VARCHAR" property="water" />
      <result column="VPP" jdbcType="VARCHAR" property="vpp" />
      <result column="I" jdbcType="VARCHAR" property="i" />
      <result column="PURINE" jdbcType="VARCHAR" property="purine" />
    </association>
  </resultMap>
  <sql id="Base_Column_List">
    id, oven_id, meal_id, cafeteria_id, sort, memo, menu_time, create_time, create_by, 
    update_time, update_by, status
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from diet_menu
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    delete from diet_menu
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.tenghong.ndip.model.diet.DietMenu">
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Integer">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into diet_menu (oven_id, meal_id, cafeteria_id, 
      sort, memo, menu_time, 
      create_time, create_by, update_time, 
      update_by, status)
    values (#{ovenId,jdbcType=INTEGER}, #{mealId,jdbcType=INTEGER}, #{cafeteriaId,jdbcType=INTEGER}, 
      #{sort,jdbcType=INTEGER}, #{memo,jdbcType=VARCHAR}, #{menuTime,jdbcType=TIMESTAMP}, 
      #{createTime,jdbcType=TIMESTAMP}, #{createBy,jdbcType=INTEGER}, #{updateTime,jdbcType=TIMESTAMP}, 
      #{updateBy,jdbcType=INTEGER}, #{status,jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" parameterType="com.tenghong.ndip.model.diet.DietMenu">
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Integer">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into diet_menu
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="ovenId != null">
        oven_id,
      </if>
      <if test="mealId != null">
        meal_id,
      </if>
      <if test="cafeteriaId != null">
        cafeteria_id,
      </if>
      <if test="sort != null">
        sort,
      </if>
      <if test="memo != null">
        memo,
      </if>
      <if test="menuTime != null">
        menu_time,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="createBy != null">
        create_by,
      </if>
      <if test="updateTime != null">
        update_time,
      </if>
      <if test="updateBy != null">
        update_by,
      </if>
      <if test="status != null">
        status,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="ovenId != null">
        #{ovenId,jdbcType=INTEGER},
      </if>
      <if test="mealId != null">
        #{mealId,jdbcType=INTEGER},
      </if>
      <if test="cafeteriaId != null">
        #{cafeteriaId,jdbcType=INTEGER},
      </if>
      <if test="sort != null">
        #{sort,jdbcType=INTEGER},
      </if>
      <if test="memo != null">
        #{memo,jdbcType=VARCHAR},
      </if>
      <if test="menuTime != null">
        #{menuTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createBy != null">
        #{createBy,jdbcType=INTEGER},
      </if>
      <if test="updateTime != null">
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateBy != null">
        #{updateBy,jdbcType=INTEGER},
      </if>
      <if test="status != null">
        #{status,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.tenghong.ndip.model.diet.DietMenu">
    update diet_menu
    <set>
      <if test="ovenId != null">
        oven_id = #{ovenId,jdbcType=INTEGER},
      </if>
      <if test="mealId != null">
        meal_id = #{mealId,jdbcType=INTEGER},
      </if>
      <if test="cafeteriaId != null">
        cafeteria_id = #{cafeteriaId,jdbcType=INTEGER},
      </if>
      <if test="sort != null">
        sort = #{sort,jdbcType=INTEGER},
      </if>
      <if test="memo != null">
        memo = #{memo,jdbcType=VARCHAR},
      </if>
      <if test="menuTime != null">
        menu_time = #{menuTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createBy != null">
        create_by = #{createBy,jdbcType=INTEGER},
      </if>
      <if test="updateTime != null">
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateBy != null">
        update_by = #{updateBy,jdbcType=INTEGER},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.tenghong.ndip.model.diet.DietMenu">
    update diet_menu
    set oven_id = #{ovenId,jdbcType=INTEGER},
      meal_id = #{mealId,jdbcType=INTEGER},
      cafeteria_id = #{cafeteriaId,jdbcType=INTEGER},
      sort = #{sort,jdbcType=INTEGER},
      memo = #{memo,jdbcType=VARCHAR},
      menu_time = #{menuTime,jdbcType=TIMESTAMP},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      create_by = #{createBy,jdbcType=INTEGER},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      update_by = #{updateBy,jdbcType=INTEGER},
      status = #{status,jdbcType=INTEGER}
    where id = #{id,jdbcType=INTEGER}
  </update>

  <select id="findPageCondition"  resultMap="MenuVoMap" parameterType="com.tenghong.ndip.utils.PageInfo">
    SELECT
    relation.relation_id as relationId,`data`.name as `name`,`data`.price as price,relation.re_goal_type as `type`,relation.re_goal_id as goalId,element.*
    FROM
    diet_relation relation
    LEFT JOIN
    <if test="condition.flag == 1" >
      diet_dish `data`
    </if>
    <if test="condition.flag == 2" >
      diet_dish_pkg `data`
    </if>
    ON
    `data`.id = relation.re_goal_id
    JOIN
    diet_menu menu
    ON
    menu.id = relation.re_parent_id
    JOIN
    diet_element element
    ON
    `data`.id = element.goal_id
    <where>
      <foreach collection="list" open=" and relation.relation_id in (" close=")"
               item="id" separator=",">
        #{id}
      </foreach>
      <if test="condition.menuDate != null and condition.menuDate != '' " >
        <![CDATA[ and DATE_FORMAT(menu.menu_time,'%Y-%m-%d') = #{condition.menuDate}]]>
      </if>
      <if test="condition.ovenId != null and condition.ovenId != '' " >
        and menu.oven_id = #{condition.ovenId}
      </if>
      <if test="condition.mealTimesId != null and condition.mealTimesId != '' " >
        and menu.meal_id = #{condition.mealTimesId}
      </if>
      <if test="condition.flag == 1" >
        and relation.re_goal_type = 2
      </if>
      <if test="condition.flag == 2" >
        and relation.re_goal_type = 3
      </if>
      and menu.status = 1
    </where>
    ORDER BY ${sort} ${order}
  </select>

  <select id="findPageCount" resultType="int" parameterType="com.tenghong.ndip.utils.PageInfo">
    SELECT COUNT(1)
    FROM
    diet_relation relation
    LEFT JOIN
      <if test="condition.flag ==  1" >
          diet_dish `data`
      </if>
      <if test="condition.flag ==  2" >
          diet_dish_pkg `data`
      </if>
    ON
    `data`.id = relation.re_goal_id
    JOIN
    diet_menu menu
    ON
    menu.id = relation.re_parent_id
    <where>
      <foreach collection="list" open=" and relation.relation_id in (" close=")"
               item="id" separator=",">
        #{id}
      </foreach>
      <if test="condition.menuDate != null and condition.menuDate != '' " >
        <![CDATA[ and DATE_FORMAT(menu.menu_time,'%Y-%m-%d') >= #{condition.menuDate}]]>
      </if>
      <if test="condition.ovenId != null and condition.ovenId != '' " >
        and menu.oven_id = #{condition.ovenId}
      </if>
      <if test="condition.mealTimesId != null and condition.mealTimesId != '' " >
        and menu.meal_id = #{condition.mealTimesId}
      </if>
      <if test="condition.flag == 1" >
        and relation.re_goal_type = 2
      </if>
      <if test="condition.flag == 2" >
        and relation.re_goal_type = 3
      </if>
      and menu.status = 1
    </where>
  </select>

  <select id="findDataByIdList"  resultType="com.tenghong.ndip.model.vo.MenuVo" parameterType="com.tenghong.ndip.utils.PageInfo">
    SELECT
    relation.relation_id as relationId,`data`.name as `name`,`data`.price as price,relation.re_goal_type as `type`,
    relation.re_goal_id as goalId,menu.meal_id as mealId,menu.oven_id as ovenId,`data`.icon as icon,
    DATE_FORMAT(menu.menu_time,'%Y-%m-%d') menuTime
    FROM
    diet_relation relation
    LEFT JOIN
    <if test="flag == 1" >
      diet_dish `data`
    </if>
    <if test="flag == 2" >
      diet_dish_pkg `data`
    </if>
    ON
    `data`.id = relation.re_goal_id
    JOIN
    diet_menu menu
    ON
    menu.id = relation.re_parent_id
    <where>
      <foreach collection="list" open=" and relation.relation_id in (" close=")"
               item="id" separator=",">
        #{id}
      </foreach>
      <if test="flag == 1" >
        and relation.re_goal_type = 2
      </if>
      <if test="flag == 2" >
        and relation.re_goal_type = 3
      </if>
      <![CDATA[ and DATE_FORMAT(menu.menu_time,'%Y-%m-%d') >= DATE_FORMAT(now(),'%Y-%m-%d')]]>
      and menu.status = 1
    </where>
  </select>

  <select id="getCopyList"  resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List" />
    FROM
    diet_menu
    <where>

      <if test="ovenId != null and ovenId.size() > 0 " >
        <foreach collection="ovenId" open=" and oven_id in (" close=")"
                 item="id" separator=",">
          #{id}
        </foreach>
      </if>
      <if test="mealId != null and mealId.size() > 0 " >
        <foreach collection="mealId" open=" and meal_id in (" close=")"
                 item="item" separator=",">
          #{item}
        </foreach>
      </if>
      <if test="menuTime != null and menuTime != '' " >
        <![CDATA[ and DATE_FORMAT(menu_time,'%Y-%m-%d') = DATE_FORMAT(#{menuTime},'%Y-%m-%d')]]>
      </if>
      and status = 1
    </where>
  </select>

  <select id="findPageConditionNew"  resultType="com.tenghong.ndip.model.vo.MenuVo" parameterType="com.tenghong.ndip.utils.PageInfo">
    SELECT
    menu.id as menuId,relation.relation_id as relationId,`data`.name as `name`,`data`.price as price,relation.re_goal_type as `type`,relation.re_goal_id as goalId,`data`.id as elementGoalId
    FROM
    diet_relation relation
    LEFT JOIN
    <if test="condition.flag == 1" >
      diet_dish `data`
    </if>
    <if test="condition.flag == 2" >
      diet_dish_pkg `data`
    </if>
    ON
    `data`.id = relation.re_goal_id
    JOIN
    diet_menu menu
    ON
    menu.id = relation.re_parent_id
    <where>
      <foreach collection="list" open=" and relation.relation_id in (" close=")"
               item="id" separator=",">
        #{id}
      </foreach>
      <if test="condition.menuDate != null and condition.menuDate != '' " >
        <![CDATA[ and DATE_FORMAT(menu.menu_time,'%Y-%m-%d') = #{condition.menuDate}]]>
      </if>
      <if test="condition.ovenId != null and condition.ovenId != '' " >
        and menu.oven_id = #{condition.ovenId}
      </if>
      <if test="condition.mealTimesId != null and condition.mealTimesId != '' " >
        and menu.meal_id = #{condition.mealTimesId}
      </if>
      <if test="condition.flag == 1" >
        and relation.re_goal_type = 2
      </if>
      <if test="condition.flag == 2" >
        and relation.re_goal_type = 3
      </if>
      and menu.status = 1
    </where>
    ORDER BY ${sort} ${order}
  </select>
</mapper>